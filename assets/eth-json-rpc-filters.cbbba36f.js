var t=Object.defineProperty,e=Object.getOwnPropertySymbols,r=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,s=(e,r,n)=>r in e?t(e,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[r]=n;import{e as o}from"./eth-query.5602d7fb.js";import{s as a}from"./@metamask.36686bb8.js";import{s as i}from"./eth-json-rpc-middleware.a176373a.js";import{d as c}from"./json-rpc-engine.a44b768a.js";import{l}from"./async-mutex.e61528bb.js";const u=(t,e,r,n)=>function(...s){return new(0,e.promiseModule)(((o,a)=>{e.multiArgs?s.push(((...t)=>{e.errorFirst?t[0]?a(t):(t.shift(),o(t)):o(t)})):e.errorFirst?s.push(((t,e)=>{t?a(t):o(e)})):s.push(o);const i=this===r?n:this;Reflect.apply(t,i,s)}))},d=new WeakMap;const p=a.default;var f=class extends p{constructor(){super(),this.updates=[]}async initialize(){}async update(){throw new Error("BaseFilter - no update method specified")}addResults(t){this.updates=this.updates.concat(t),t.forEach((t=>this.emit("update",t)))}addInitialResults(t){}getChangesAndClear(){const t=this.updates;return this.updates=[],t}};const h=f;var m={minBlockRef:function(...t){return y(t)[0]},maxBlockRef:function(...t){const e=y(t);return e[e.length-1]},sortBlockRefs:y,bnToHex:function(t){return"0x"+t.toString(16)},blockRefIsNumber:function(t){return t&&!["earliest","latest","pending"].includes(t)},hexToInt:w,incrementHexInt:function(t){if(null==t)return t;return g(w(t)+1)},intToHex:g,unsafeRandomBytes:function(t){let e="0x";for(let r=0;r<t;r++)e+=b(),e+=b();return e}};function y(t){return t.sort(((t,e)=>"latest"===t||"earliest"===e?1:"latest"===e||"earliest"===t?-1:w(t)-w(e)))}function w(t){return null==t?t:Number.parseInt(t,16)}function g(t){if(null==t)return t;let e=t.toString(16);return e.length%2&&(e="0"+e),"0x"+e}function b(){return Math.floor(16*Math.random()).toString(16)}const k=o,B=(t,o)=>{o=((t,o)=>{for(var a in o||(o={}))r.call(o,a)&&s(t,a,o[a]);if(e)for(var a of e(o))n.call(o,a)&&s(t,a,o[a]);return t})({exclude:[/.+(?:Sync|Stream)$/],errorFirst:!0,promiseModule:Promise},o);const a=typeof t;if(null===t||"object"!==a&&"function"!==a)throw new TypeError(`Expected \`input\` to be a \`Function\` or \`Object\`, got \`${null===t?"null":a}\``);const i=new WeakMap,c=new Proxy(t,{apply(t,e,r){const n=i.get(t);if(n)return Reflect.apply(n,e,r);const s=o.excludeMain?t:u(t,o,c,t);return i.set(t,s),Reflect.apply(s,e,r)},get(t,e){const r=t[e];if(!((t,e)=>{let r=d.get(t);if(r||(r={},d.set(t,r)),e in r)return r[e];const n=t=>"string"==typeof t||"symbol"==typeof e?e===t:t.test(e),s=Reflect.getOwnPropertyDescriptor(t,e),a=void 0===s||s.writable||s.configurable,i=(o.include?o.include.some(n):!o.exclude.some(n))&&a;return r[e]=i,i})(t,e)||r===Function.prototype[e])return r;const n=i.get(r);if(n)return n;if("function"==typeof r){const e=u(r,o,c,t);return i.set(r,e),e}return r}});return c},x=class extends h{constructor(){super(),this.allResults=[]}async update(){throw new Error("BaseFilterWithHistory - no update method specified")}addResults(t){this.allResults=this.allResults.concat(t),super.addResults(t)}addInitialResults(t){this.allResults=this.allResults.concat(t),super.addInitialResults(t)}getAllResults(){return this.allResults}},{bnToHex:v,hexToInt:R,incrementHexInt:F,minBlockRef:I,blockRefIsNumber:L}=m;var j=class extends x{constructor({provider:t,params:e}){super(),this.type="log",this.ethQuery=new k(t),this.params=Object.assign({fromBlock:"latest",toBlock:"latest",address:void 0,topics:[]},e),this.params.address&&(Array.isArray(this.params.address)||(this.params.address=[this.params.address]),this.params.address=this.params.address.map((t=>t.toLowerCase())))}async initialize({currentBlock:t}){let e=this.params.fromBlock;["latest","pending"].includes(e)&&(e=t),"earliest"===e&&(e="0x0"),this.params.fromBlock=e;const r=I(this.params.toBlock,t),n=Object.assign({},this.params,{toBlock:r}),s=await this._fetchLogs(n);this.addInitialResults(s)}async update({oldBlock:t,newBlock:e}){const r=e;let n;n=t?F(t):e;const s=Object.assign({},this.params,{fromBlock:n,toBlock:r}),o=(await this._fetchLogs(s)).filter((t=>this.matchLog(t)));this.addResults(o)}async _fetchLogs(t){return await B((e=>this.ethQuery.getLogs(t,e)))()}matchLog(t){if(R(this.params.fromBlock)>=R(t.blockNumber))return!1;if(L(this.params.toBlock)&&R(this.params.toBlock)<=R(t.blockNumber))return!1;const e=t.address&&t.address.toLowerCase();if(this.params.address&&e&&!this.params.address.includes(e))return!1;return this.params.topics.every(((e,r)=>{let n=t.topics[r];if(!n)return!1;n=n.toLowerCase();let s=Array.isArray(e)?e:[e];if(s.includes(null))return!0;s=s.map((t=>t.toLowerCase()));return s.includes(n)}))}},C=async function({provider:t,fromBlock:e,toBlock:r}){e||(e=r);const n=H(e),s=H(r),o=Array(s-n+1).fill().map(((t,e)=>n+e)).map(A);return await Promise.all(o.map((e=>function(t,e,r){return new Promise(((n,s)=>{t.sendAsync({id:1,jsonrpc:"2.0",method:e,params:r},((t,e)=>{if(t)return s(t);n(e.result)}))}))}(t,"eth_getBlockByNumber",[e,!1]))))};function H(t){return null==t?t:Number.parseInt(t,16)}function A(t){if(null==t)return t;return"0x"+t.toString(16)}const M=f,T=C,{incrementHexInt:_}=m;var E=class extends M{constructor({provider:t,params:e}){super(),this.type="block",this.provider=t}async update({oldBlock:t,newBlock:e}){const r=e,n=_(t),s=(await T({provider:this.provider,fromBlock:n,toBlock:r})).map((t=>t.hash));this.addResults(s)}};const O=f,P=C,{incrementHexInt:S}=m;var N=class extends O{constructor({provider:t}){super(),this.type="tx",this.provider=t}async update({oldBlock:t}){const e=t,r=S(t),n=await P({provider:this.provider,fromBlock:r,toBlock:e}),s=[];for(const o of n)s.push(...o.transactions);this.addResults(s)}};const $=l.Mutex,{createAsyncMiddleware:U}=c,q=i,z=j,D=E,W=N,{intToHex:Q,hexToInt:G}=m;var J=function({blockTracker:t,provider:e}){let r=0,n={};const s=new $,o=function({mutex:t}){return e=>async(r,n,s,o)=>{(await t.acquire())(),e(r,n,s,o)}}({mutex:s}),a=q({eth_newFilter:o(K(c)),eth_newBlockFilter:o(K(l)),eth_newPendingTransactionFilter:o(K(u)),eth_uninstallFilter:o(V(f)),eth_getFilterChanges:o(V(d)),eth_getFilterLogs:o(V(p))}),i=async({oldBlock:t,newBlock:e})=>{if(0===n.length)return;const r=await s.acquire();try{await Promise.all(X(n).map((async r=>{try{await r.update({oldBlock:t,newBlock:e})}catch(n){console.error(n)}})))}catch(o){console.error(o)}r()};return a.newLogFilter=c,a.newBlockFilter=l,a.newPendingTransactionFilter=u,a.uninstallFilter=f,a.getFilterChanges=d,a.getFilterLogs=p,a.destroy=()=>{!async function(){const t=X(n).length;n={},m({prevFilterCount:t,newFilterCount:0})}()},a;async function c(t){const r=new z({provider:e,params:t});return await h(r),r}async function l(){const t=new D({provider:e});return await h(t),t}async function u(){const t=new W({provider:e});return await h(t),t}async function d(t){const e=G(t),r=n[e];if(!r)throw new Error(`No filter for index "${e}"`);return r.getChangesAndClear()}async function p(t){const e=G(t),r=n[e];if(!r)throw new Error(`No filter for index "${e}"`);return"log"===r.type?results=r.getAllResults():results=[],results}async function f(t){const e=G(t),r=n[e],s=Boolean(r);return s&&await async function(t){const e=X(n).length;delete n[t];const r=X(n).length;m({prevFilterCount:e,newFilterCount:r})}(e),s}async function h(e){const s=X(n).length,o=await t.getLatestBlock();await e.initialize({currentBlock:o}),r++,n[r]=e,e.id=r,e.idHex=Q(r);return m({prevFilterCount:s,newFilterCount:X(n).length}),r}function m({prevFilterCount:e,newFilterCount:r}){0===e&&r>0?t.on("sync",i):e>0&&0===r&&t.removeListener("sync",i)}};function K(t){return V((async(...e)=>{const r=await t(...e);return Q(r.id)}))}function V(t){return U((async(e,r)=>{const n=await t.apply(null,e.params);r.result=n}))}function X(t,e){const r=[];for(let n in t)r.push(t[n]);return r}const Y=a.default,Z=i,{createAsyncMiddleware:tt}=c,et=J,{unsafeRandomBytes:rt,incrementHexInt:nt}=m,st=C;var ot=function({blockTracker:t,provider:e}){const r={},n=et({blockTracker:t,provider:e});let s=!1;const o=new Y,a=Z({eth_subscribe:tt((async function(o,a){if(s)throw new Error("SubscriptionManager - attempting to use after destroying");const c=o.params[0],l=rt(16);let u;switch(c){case"newHeads":u=d({subId:l});break;case"logs":const t=o.params[1];u=p({subId:l,filter:await n.newLogFilter(t)});break;default:throw new Error(`SubscriptionManager - unsupported subscription type "${c}"`)}return r[l]=u,void(a.result=l);function d({subId:r}){const n={type:c,destroy:async()=>{t.removeListener("sync",n.update)},update:async({oldBlock:t,newBlock:n})=>{const s=n,o=nt(t);(await st({provider:e,fromBlock:o,toBlock:s})).map(at).forEach((t=>{i(r,t)}))}};return t.on("sync",n.update),n}function p({subId:t,filter:e}){e.on("update",(e=>i(t,e)));return{type:c,destroy:async()=>await n.uninstallFilter(e.idHex)}}})),eth_unsubscribe:tt((async function(t,e){if(s)throw new Error("SubscriptionManager - attempting to use after destroying");const n=t.params[0],o=r[n];if(!o)return void(e.result=!1);delete r[n],await o.destroy(),e.result=!0}))});return a.destroy=function(){o.removeAllListeners();for(const t in r)r[t].destroy(),delete r[t];s=!0},{events:o,middleware:a};function i(t,e){o.emit("notification",{jsonrpc:"2.0",method:"eth_subscription",params:{subscription:t,result:e}})}};function at(t){return{hash:t.hash,parentHash:t.parentHash,sha3Uncles:t.sha3Uncles,miner:t.miner,stateRoot:t.stateRoot,transactionsRoot:t.transactionsRoot,receiptsRoot:t.receiptsRoot,logsBloom:t.logsBloom,difficulty:t.difficulty,number:t.number,gasLimit:t.gasLimit,gasUsed:t.gasUsed,nonce:t.nonce,mixHash:t.mixHash,timestamp:t.timestamp,extraData:t.extraData}}export{ot as s};
